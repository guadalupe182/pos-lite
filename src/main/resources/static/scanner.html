<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>POS-lite Scanner</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 16px; }
        .row { display: flex; gap: 16px; flex-wrap: wrap; }
        video { width: 320px; max-width: 100%; border-radius: 12px; }
        pre { background: #111; color:#0f0; padding:12px; border-radius:12px; max-height:40vh; overflow:auto; }
        input, button, select { padding: 8px 12px; font-size: 14px; }
        .card { border: 1px solid #eee; border-radius: 12px; padding: 12px; }
        .ok { color: #0a0; }
        .err { color: #b00; }
        .muted { color: #666; font-size: 12px; }
        label.inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    </style>
</head>
<body>
<h1>POS-lite · Escáner</h1>

<div class="card">
    <strong>Credenciales API (Basic Auth)</strong><br/>
    <input id="user" placeholder="usuario" autocomplete="username" />
    <input id="pass" placeholder="contraseña" type="password" autocomplete="current-password" />
    <button id="save">Guardar</button>
    <span id="authState"></span>
</div>

<div class="row" style="margin-top:12px;">
    <div class="card">
        <video id="preview" autoplay muted playsinline></video><br/>
        <button id="toggle">Iniciar cámara</button>
        <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <label class="inline"><input type="checkbox" id="autoDecrement" /> Restar 1 al escanear</label>
            <label class="inline">Cantidad: <input type="number" id="decQty" value="1" min="1" style="width:80px;"></label>
            <button id="torchBtn" type="button">Linterna</button>
        </div>
        <button id="stop" disabled>Detener</button>
    </div>

    <div class="card" style="flex:1; min-width:280px;">
        <div>Último código leído: <strong id="lastCode">-</strong></div>
        <div id="status"></div>
        <pre id="out">{}</pre>
    </div>

    <div class="card" id="quickCreate" style="display:none; margin-top:12px; flex:1; min-width:280px;">
        <h3>Alta rápida</h3>
        <div class="muted">Escaneaste: <strong id="qc_barcode">-</strong></div>

        <label>Nombre<br>
            <input id="qc_name" placeholder="Nombre del producto" />
        </label><br>

        <label>Categoría (existente)<br>
            <select id="qc_category"></select>
        </label>
        <div class="muted">— ó —</div>
        <label>Nueva categoría (crea si no existe)<br>
            <input id="qc_new_category" placeholder="Ej. Bebidas energéticas" />
        </label><br>

        <label>Precio<br>
            <input id="qc_price" type="number" step="0.01" min="0" inputmode="decimal" />
        </label><br>

        <label>Umbral minStock (alerta por agotarse)<br>
            <input id="qc_minstock" type="number" min="0" value="10" inputmode="numeric" />
        </label><br>

        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <label class="inline">Unidades a entrar:
                <input id="qc_qty" type="number" value="1" min="1" style="width:80px;" />
            </label>
            <button id="qc_save" type="button">Crear + Entrar</button>
            <button id="qc_cancel" type="button">Cancelar</button>
        </div>
        <small>Se creará el producto y se <b>sumará</b> el stock con la cantidad indicada.</small>
        <div id="qc_msg" class=""></div>
    </div>
</div>

<script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";

    // ====== UI ======
    const userEl    = document.getElementById('user');
    const passEl    = document.getElementById('pass');
    const saveBtn   = document.getElementById('save');
    const authState = document.getElementById('authState');

    const preview   = document.getElementById('preview');
    const toggle    = document.getElementById('toggle');
    const stopBtn   = document.getElementById('stop');
    const torchBtn  = document.getElementById('torchBtn');

    const lastCode  = document.getElementById('lastCode');
    const statusEl  = document.getElementById('status');
    const out       = document.getElementById('out');

    const autoDec   = document.getElementById('autoDecrement');
    const decQtyEl  = document.getElementById('decQty');

    const qc = {
      box:   document.getElementById('quickCreate'),
      bc:    document.getElementById('qc_barcode'),
      name:  document.getElementById('qc_name'),
      cat:   document.getElementById('qc_category'),
      newCat:document.getElementById('qc_new_category'),
      price: document.getElementById('qc_price'),
      min:   document.getElementById('qc_minstock'),
      qty:   document.getElementById('qc_qty'),
      save:  document.getElementById('qc_save'),
      cancel:document.getElementById('qc_cancel'),
      msg:   document.getElementById('qc_msg'),
    };

    // ====== Credenciales ======
    function setAuthState(ok, msg) {
      authState.textContent = msg;
      authState.className = ok ? 'ok' : 'err';
    }
    function saveCreds() {
      localStorage.setItem('pos_user', userEl.value.trim());
      localStorage.setItem('pos_pass', passEl.value);
      setAuthState(true, 'Guardado');
    }
    function getAuthHeader() {
      const u = localStorage.getItem('pos_user') || '';
      const p = localStorage.getItem('pos_pass') || '';
      if (!u || !p) return null;
      return 'Basic ' + btoa(`${u}:${p}`);
    }
    (function initCreds(){
      const u = localStorage.getItem('pos_user');
      const p = localStorage.getItem('pos_pass');
      if (u) userEl.value = u;
      if (p) passEl.value = p;
      setAuthState(!!(u && p), (u && p) ? 'Listo' : 'Faltan credenciales');
    })();
    saveBtn.addEventListener('click', saveCreds);

    // ====== Beep (WebAudio) ======
    let audioCtx = null;
    function ensureAudioCtx() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
      }
    }
    function beep() {
      if (!audioCtx) return;
      try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 880;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
        osc.start();
        setTimeout(() => {
          gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
          osc.stop(audioCtx.currentTime + 0.06);
        }, 60);
      } catch {}
    }
    toggle.addEventListener('click', () => { ensureAudioCtx(); }, { once: true });

    // ====== Scanner ======
    const reader = new BrowserMultiFormatReader();
    let running = false;

    // antirrebote
    let lastScanAt = 0;
    let lastScanVal = '';
    const SCAN_COOLDOWN_MS = 800;

    // Torch (si el device lo soporta)
    torchBtn.addEventListener('click', async () => {
      const track = preview.srcObject?.getVideoTracks?.()[0];
      if (!track) return;
      const capabilities = track.getCapabilities?.();
      if (capabilities && 'torch' in capabilities) {
        const settings = (track.getSettings && track.getSettings()) || {};
        const on = !settings.torch;
        try {
          await track.applyConstraints({ advanced: [{ torch: on }] });
          torchBtn.textContent = on ? 'Linterna (on)' : 'Linterna';
        } catch {}
      }
    });

    function showQuickCreate(barcode){
      qc.bc.textContent = barcode;
      qc.name.value = '';
      qc.price.value = '';
      qc.min.value = '10';
      qc.qty.value = '1';
      qc.newCat.value = '';
      qc.msg.textContent = '';
      qc.msg.className = '';
      qc.box.style.display = 'block';
      loadCategories();
    }
    function hideQuickCreate(){
      qc.box.style.display = 'none';
    }

    async function loadCategories(){
      const auth = getAuthHeader(); if (!auth) return;
      try{
        const r = await fetch('/api/categories', {
          headers: { 'Accept': 'application/json', 'Authorization': auth }
        });
        if(!r.ok) return;
        const cats = await r.json();
        qc.cat.innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      }catch {}
    }

    // ====== Packs ======
    async function sellPack(barcode, qty) {
      const auth = getAuthHeader();
      if (!auth) {
        statusEl.textContent = '⚠️ Guarda credenciales primero';
        statusEl.className = 'err';
        return true; // ya manejado
      }

      try {
        const body = {
          barcode,
          qty,
          reason: 'SALE'
        };

        const r = await fetch('/api/packs/sell', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': auth
          },
          body: JSON.stringify(body)
        });

        if (r.ok) {
          const data = await r.json();
          out.textContent = JSON.stringify(data, null, 2);
          statusEl.textContent = `✔ Pack vendido (${qty}x)`;
          statusEl.className = 'ok';
          hideQuickCreate();
          beep();
          return true;
        } else if (r.status === 404) {
          // No hay pack con ese código: dejamos que el caller decida si usa Alta rápida
          return false;
        } else if (r.status === 409) {
          statusEl.textContent = '⚠️ Pack sin stock suficiente';
          statusEl.className = 'err';
          out.textContent = await r.text();
          return true;
        } else {
          statusEl.textContent = `Error al vender pack (${r.status})`;
          statusEl.className = 'err';
          out.textContent = await r.text();
          return true;
        }
      } catch (e) {
        statusEl.textContent = 'Error de red al vender pack';
        statusEl.className = 'err';
        out.textContent = String(e);
        return true;
      }
    }

    // ====== Productos ======
    async function fetchProductByBarcode(code, qtyForPack) {
      const auth = getAuthHeader();
      if (!auth) {
        statusEl.textContent = '⚠️ Guarda credenciales primero';
        statusEl.className='err';
        return null;
      }
      statusEl.textContent = 'Buscando...';
      statusEl.className = '';

      try {
        const r = await fetch(`/api/products/barcode/${encodeURIComponent(code)}`, {
          headers: { 'Accept':'application/json', 'Authorization':auth }
        });
        if (r.ok) {
          hideQuickCreate();
          const data = await r.json();
          out.textContent = JSON.stringify(data, null, 2);
          statusEl.textContent = '✔ Producto encontrado';
          statusEl.className = 'ok';
          beep();
          return data;
        } else if (r.status === 404) {
          // Producto no existe: probamos si es un PACK
          const handledByPack = await sellPack(code, qtyForPack || 1);
          if (handledByPack) {
            // Si sellPack devolvió true, ya mostró mensaje (éxito o error)
            return null;
          }

          // No es pack tampoco ⇒ usamos Alta rápida
          out.textContent = '{}';
          statusEl.textContent = 'No encontrado, usa Alta rápida';
          statusEl.className = 'err';
          showQuickCreate(code);
          return null;
        } else {
          out.textContent = await r.text();
          statusEl.textContent = `Error ${r.status}`;
          statusEl.className = 'err';
          return null;
        }
      } catch (e) {
        statusEl.textContent = 'Error de red';
        statusEl.className = 'err';
        out.textContent = String(e);
        return null;
      }
    }

    async function decrementStock(id, qty) {
      const auth = getAuthHeader();
      if (!auth) return;

      try {
        const r = await fetch(`/api/products/${id}/decrement?qty=${qty}`, {
          method: 'PATCH',
          headers: { 'Accept': 'application/json', 'Authorization': auth }
        });
        if (r.ok) {
          const updated = await r.json();
          out.textContent = JSON.stringify(updated, null, 2);
          statusEl.textContent = '✔ Descontado';
          statusEl.className = 'ok';
        } else if (r.status === 409) {
          statusEl.textContent = '⚠️ Sin stock suficiente';
          statusEl.className = 'err';
        } else {
          statusEl.textContent = `Error al descontar (${r.status})`;
          statusEl.className = 'err';
        }
      } catch (e) {
        statusEl.textContent = 'Error de red al descontar';
        statusEl.className = 'err';
      }
    }

    async function startCamera() {
      if (running) return;
      running = true;
      toggle.disabled = true;
      stopBtn.disabled = false;

      const devices = await reader.listVideoInputDevices();
      const backCam = devices.find(d => /back|trasera|rear/i.test(d.label)) || devices[0];

      await reader.decodeFromVideoDevice(backCam?.deviceId, preview, async (res, err) => {
        if (res) {
          const code = res.getText();
          if (!code) return;

          const now = Date.now();
          if (code === lastScanVal && (now - lastScanAt) < SCAN_COOLDOWN_MS) return;
          lastScanVal = code; lastScanAt = now;

          lastCode.textContent = code;

          // cantidad a usar tanto para auto-decremento como para packs
          const q = Math.max(1, parseInt(decQtyEl.value || '1', 10));

          // buscar producto; si no existe intentará vender pack
          const prod = await fetchProductByBarcode(code, q);

          // Si es producto y auto-decrement está activo, descontar stock
          if (prod && autoDec.checked) {
            await decrementStock(prod.id, q);
          }
        }
      });
    }

    function stopCamera() {
      reader.reset();
      running = false;
      toggle.disabled = false;
      stopBtn.disabled = true;
    }

    toggle.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);

    // Guardar desde “Alta rápida”
    qc.save.addEventListener('click', async () => {
      const auth = getAuthHeader();
      if (!auth) { qc.msg.textContent = 'Faltan credenciales'; qc.msg.className='err'; return; }

      const barcode = qc.bc.textContent;
      const name = qc.name.value.trim();
      const price = parseFloat(qc.price.value);
      const qty   = Math.max(1, parseInt(qc.qty.value || '1', 10));
      const minStock = Math.max(0, parseInt(qc.min.value || '10', 10));

      const newCatName = qc.newCat.value.trim();
      const catId = parseInt(qc.cat.value || '0', 10) || null;

      if (!name || Number.isNaN(price)) {
        qc.msg.textContent = 'Completa nombre y precio.';
        qc.msg.className = 'err'; return;
      }
      if (!newCatName && !catId) {
        qc.msg.textContent = 'Selecciona una categoría o escribe una nueva.';
        qc.msg.className = 'err'; return;
      }

      const body = {
        barcode,
        delta: qty,
        reason: 'INBOUND',
        name,
        price,
        minStock
      };
      if (newCatName) body.categoryName = newCatName;
      else body.categoryId = catId;

      try {
        const r = await fetch('/api/products/adjust-by-barcode', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json', 'Authorization':auth },
          body: JSON.stringify(body)
        });

        if (r.ok) {
          const data = await r.json();
          out.textContent = JSON.stringify(data, null, 2);
          statusEl.textContent = '✔ Creado y stock actualizado';
          statusEl.className = 'ok';
          beep();
          hideQuickCreate();
        } else {
          qc.msg.textContent = `Error ${r.status}: ` + await r.text();
          qc.msg.className = 'err';
        }
      } catch (e) {
        qc.msg.textContent = 'Error de red';
        qc.msg.className = 'err';
      }
    });

    qc.cancel.addEventListener('click', hideQuickCreate);
</script>
</body>
</html>
